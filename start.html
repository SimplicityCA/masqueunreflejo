<!DOCTYPE html>
<html lang="en" ng-app="confusionApp">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>M&aacute;s Que Un Reflejo</title>    
        <!-- Bootstrap -->
<!-- build:css styles/main.css -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="node_modules/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="dist/styles/master.css" rel="stylesheet">
    
<!-- endbuild -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div id="container" class="container">
        <div class="row">
        	<div class="header col-xs-12">
              	<img src="assets/mas-que-un-reflejo.png" alt="mas que un reflejo" class="img"/>
            </div>
        </div>
        <div class="row">
            <div id="efect-content" class="efect-content col-xs-12">
                <div class="col-sm-3 col-xs-12 efects-container">
                    <p class="effect-title">Sube tu foto y selecciona un efecto:</p>
<!--                     <select class="form-control" name="deformation" id="deform">
                        <option value="Malestar">Malestar</option>
                        <option value="Inca">Inca</option>
                        <option value="Alegre">Alegre</option>
                        <option value="Atontado">Atontado</option>
                        <option value="Cara larga">Cara larga</option>
                        <option value="Suertudo">Suertudo</option>
                        <option value="Lindo">Lindo</option>
                        <option value="Dormido">Dormido</option>
                        <option value="Malvado">Malvado</option>
                        <option value="Artificial">Artificial</option>
                        <option value="Ninguno">Ninguno</option>
                    </select> -->

                   <!--  <input class="btn btn-success btn-lg btn-block" type="button" value="Dar efecto" onclick="startVideo()" id="startbutton"> -->
                    
                </div>
                <div class="col-sm-9 col-xs-12">
                   <div class="col-sm-6 col-md-offset-2 canvas-container">
                        <canvas id="image" style="border:1px solid #000000;"  width="500" height="500" >
                            Your browser does not support the HTML5 canvas tag.
                        </canvas>
                        <canvas id="overlay" width="500" height="500" style="z-index: 50;"></canvas>
                        <canvas id="webgl" width="500" height="500" style="z-index: 500;"></canvas>
                    </div> 

                    <div style="display:none;cursor: pointer; width: 80px; opacity: 0.9; z-index: 10001; position: absolute; top: 0px;"><div style="text-align: left; line-height: 1.2em; background-color: rgb(8, 8, 24); padding: 0px 0px 3px 3px;"><div style="font-family: Helvetica, Arial, sans-serif; font-size: 9px; color: rgb(0, 255, 255); font-weight: bold;"></div><div style="position: relative; width: 74px; height: 30px; background-color: rgb(0, 255, 255);"><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span><span style="width: 1px; height: 30px; float: left; background-color: rgb(16, 16, 48);"></span></div></div><div style="text-align: left; line-height: 1.2em; background-color: rgb(8, 24, 8); padding: 0px 0px 3px 3px; display: none;"><div style="font-family: Helvetica, Arial, sans-serif; font-size: 9px; color: rgb(0, 255, 0); font-weight: bold;">MS</div><div style="position: relative; width: 74px; height: 30px; background-color: rgb(0, 255, 0);"><span style="width: 1px; height: 4.27474px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 12.7846px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.017px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 11.4125px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 2.5707px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 16.3137px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 16.0598px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 4.85644px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 10.6508px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 21.6129px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 28.6118px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 8.51672px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 8.59362px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 10.6474px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 17.0529px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 25.0104px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 21.9584px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 0.357608px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 15.3942px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 11.8628px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 11.4635px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.8665px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 11.583px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 22.3665px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 26.2869px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 13.9059px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 24.5935px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 16.1896px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 28.8372px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 15.8241px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 3.75458px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 0.586976px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 21.7921px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 7.78568px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 24.8711px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 4.64035px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 14.9013px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 5.1272px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 16.9599px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 6.32179px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 23.5757px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 3.41358px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.9786px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 2.17336px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 9.44664px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 18.1339px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 13.5615px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 0.634406px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 10.8427px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.6467px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 7.33552px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 9.27873px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 17.2382px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 18.5373px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 2.24355px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 1.59073px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 0.968195px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 20.0625px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 25.853px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 9.78658px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.2632px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 25.5337px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 23.3443px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 4.05129px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 23.0714px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 10.1759px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 29.093px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 14.0281px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 26.2424px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 26.9029px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 5.59319px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 20.793px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 10.8222px; float: left; background-color: rgb(16, 48, 16);"></span><span style="width: 1px; height: 17.7937px; float: left; background-color: rgb(16, 48, 16);"></span></div></div></div>
                    <br>
        
                    <p  style="display: none;" id="convergence"></p>
                    
                </div>
                
                
                <div class="button-container col-sm-9 col-md-offset-3" >
                        <div class="col-xs-12 col-md-9 col-lg-8 col-md-offset-2 down-buttons">
                            <input id="file-input" type="file" class="filestyle" data-buttonText="Buscar Archivo">
                        </div>
                        <div id="function_buttons" class="col-xs-12 col-md-9 col-lg-8 col-md-offset-2 down-buttons" style="display:none;">
                            <a  class="btn btn-primary btn-common btn-lg btn-block" onclick="rotate()" href="#">Rotar</a>
                            <hr>
                            <div class="form-group">
                            <label id="label-message" for="message">Mensaje:</label>
                            <input type="text" class="form-control" id="message" placeholder="Mensaje">
                          </div>
                            <a class="btn btn-primary btn-lg btn-block"  onclick="postCanvasToFacebook()" >Compartir en fb</a>
                        </div>
                     <input id="malestar" class="btn btn-success btn-lg btn-block" type="button" value="Malestar">
                     <input id="inca" class="btn btn-success btn-lg btn-block" type="button" value="Inca">
                     <input id="alegre" class="btn btn-success btn-lg btn-block" type="button" value="Alegre">
                     <input id="atontado" class="btn btn-success btn-lg btn-block" type="button" value="Atontado">
                     <input id="larga" class="btn btn-success btn-lg btn-block" type="button" value="Cara larga">
                     <input id="suertudo" class="btn btn-success btn-lg btn-block" type="button" value="Suertudo">
                     <input id="lindo" class="btn btn-success btn-lg btn-block" type="button" value="Lindo">
                     <input id="dormido" class="btn btn-success btn-lg btn-block" type="button" value="Dormido">
                     <input id="malvado" class="btn btn-success btn-lg btn-block" type="button" value="Malvado">
                     <input id="artificial" class="btn btn-success btn-lg btn-block" type="button" value="Artificial">
                     <input id="ninguno" class="btn btn-success btn-lg btn-block" type="button" value="Ninguno">
                    </div>
            </div>
        </div>
    </div>
    <footer class="footer">
	      <div class="container">
	        <img src="assets/footer-pratonato-san-jose.png" alt="mas que un reflejo" class="img"/>
	      </div>
	    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- build:js scripts/main.js -->
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- endbuild -->
    <script src="js/pubnub-3.15.2.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/dat.gui.min.js"></script>
    <script src="js/numeric-1.2.6.min.js"></script>
    <script src="js/mosse.js"></script>
    <script src="js/jsfeat-min.js"></script>
    <script src="js/frontalface.js"></script>
    <script src="js/jsfeat_detect.js"></script>
    <script src="js/left_eye_filter.js"></script>
    <script src="js/right_eye_filter.js"></script>
    <script src="js/nose_filter.js"></script>
    <script src="js/model_pca_20_svm.js"></script>
    <!-- <script src="js/clm.js"></script> -->
    <script src="js/svmfilter_webgl.js"></script>
    <script src="js/svmfilter_fft.js"></script>
    <script src="js/mossefilter.js"></script>
    <script src="js/Stats.js"></script>
    <link rel="stylesheet" type="text/css" href="js/imgareaselect-default.css">
    <script src="js/face_deformer.js"></script>
    <script src="js/clmtrackr.js"></script>
    <script src="js/model_pca_20_svm.js"></script> 
    <script src="js/facebook.js"></script>
    <script src="js/base64binary.js"></script>
    <script src="js/poisson_new.js"></script>
    <script src="js/jquery.imgareaselect.pack.js"></script>
    <script type="text/javascript" src="js/bootstrap-filestyle.min.js"> </script>
    <script>
        $(document).ready(function(){
            $("#next").on("click",function(){
                $("#canvas-content").hide();
                $("#efect-content").show();
            })
            $("#back").on("click",function(){
                $("#canvas-content").show();
                $("#efect-content").hide();
            })
          $("#overlay").on("click",function(){
            //click on overlay to draw canvas
                    $('#image').css('z-index',20);
                    $('#overlay').css('z-index',10);
            }) 
            $("input:file").change(function (){
               
               $(".down-buttons").show();
             }); 
        })
        //filter words
            $(function(){

                var timer = 0;
                var sensor_word = ['culo', 'caca', 'sexo', 'verga'];

                $('#message').on('keyup', function(){

                    clearTimeout(timer);
                    var new_value = this.value;
                    var new_sensor = $('#message').val();

                    $.each(sensor_word, function (idx, word) {
                      new_sensor = new_sensor.replace(word, '***');
                    }); 

                    timer = setTimeout(function(){
                         $('#message').val( new_sensor );
                    }, 0);

                });

                $('#message').on('keydown', function(){
                    clearTimeout(timer);
                });


            });
        //rotate canvas
        function rotate () {
            var canvas = document.getElementById("image");
            var context = canvas.getContext("2d");
            var cw = canvas.width;
            var ch = canvas.height;
            var myImageData, rotating = false;
        if (!rotating) {

            rotating = true;            
            // store current data to an image
            myImageData = new Image();
            myImageData.src = canvas.toDataURL();

            myImageData.onload = function () {
                // reset the canvas with new dimensions
                canvas.width = ch;
                canvas.height = cw;
                cw = canvas.width;
                ch = canvas.height;

                context.save();
                // translate and rotate
                context.translate(cw, ch / cw);
                context.rotate(Math.PI / 2);
                // draw the previows image, now rotated
                context.drawImage(myImageData, 0, 0);               
                context.restore();

                // clear the temporary image
                myImageData = null;

                rotating = false;               
            }
        }
    }
    </script>
    <script>
                var cc = document.getElementById('image').getContext('2d');
                var overlay = document.getElementById('overlay');
                var overlayCC = overlay.getContext('2d');
                var img = new Image();
                var canvasResult = document.createElement('canvas');

                img.onload = function() {
                    cc.drawImage(img,0,0,625, 500);
                };
                // img.src = 'assets/franck_02159.jpg';
            
                var ctrack = new clm.tracker({stopOnConvergence : true});
                ctrack.init(pModel);
            
                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                document.getElementById('container').appendChild( stats.domElement );
                
                var drawRequest;
                
                function animateClean() {
                    $('#image').css('z-index',10);
                    $('#overlay').css('z-index',20);
                    ctrack.start(document.getElementById('image'));
                    drawLoop();
                }

                function animate(box) {
                    ctrack.start(document.getElementById('image'), box);
                    drawLoop();
                }
                
                function drawLoop() {
                    drawRequest = requestAnimFrame(drawLoop);
                    overlayCC.clearRect(0, 0, 720, 576);
                    if (ctrack.getCurrentPosition()) {
                        //ctrack.draw(overlay);
                    }
                }
                
                // detect if tracker fails to find a face
                document.addEventListener("clmtrackrNotFound", function(event) {
                    ctrack.stop();
                    alert("Hubieron problemas para encontrar el rostro en la imagen. Por favor intenta con otra.")
                }, false);
                
                // detect if tracker loses tracking of face
                document.addEventListener("clmtrackrLost", function(event) {
                    ctrack.stop();
                    alert("Hubieron problemas para encontrar el rostro en la imagen. Por favor intenta con otra.")
                }, false);
                
                // detect if tracker has converged
                document.addEventListener("clmtrackrConverged", function(event) {
                    document.getElementById('convergence').innerHTML = "CONVERGED";
                    document.getElementById('convergence').style.backgroundColor = "#00FF00";
                    // stop drawloop
                    cancelAnimationFrame(drawRequest);
                    // console.log('converged'); //todo: check and stop infinite call here
                }, false);
                
                // update stats on iteration
                document.addEventListener("clmtrackrIteration", function(event) {
                    stats.update();
                }, false);

                // manual selection of faces (with jquery imgareaselect plugin)
                function selectBox() {
                    overlayCC.clearRect(0, 0, 720, 576);
                    document.getElementById('convergence').innerHTML = "";
                    ctrack.reset();
                    $('#overlay').addClass('hide');
                    $('#image').imgAreaSelect({
                        handles : true,
                        onSelectEnd : function(img, selection) {
                            // create box
                            var box = [selection.x1, selection.y1, selection.width, selection.height];
                            
                            // do fitting
                            animate(box);
                            $('#overlay').removeClass('hide');
                        },
                        autoHide : true
                    });
                }
                function convertCanvasToImage(canvas) {
                    var image = new Image();
                    image.src = canvas.toDataURL("image/png");
                    return image;
                }
                // function to load images on canvas 
                function loadImage() {
                    if (fileList.indexOf(fileIndex) < 0) {
                        var reader = new FileReader();
                        reader.onload = (function(theFile) {
                            return function(e) {
                                // check if positions already exist in storage
                            
                                // Render thumbnail.
                                var canvas = document.getElementById('image')
                                var overlay= document.getElementById('overlay')
                                var webgl = document.getElementById('webgl')
                                var cc = canvas.getContext('2d');
                                var img = new Image();
                                img.onload = function() {
                                    if (img.height > 500 || img.width > 700) { //estos valores se podría mandar como parametros dependiendo del dispositivo
                                        var rel = img.height/img.width;
                                        var neww = 500;
                                        var newh = neww*rel;
                                        if (newh > 500) {
                                            newh = 500;
                                            neww = newh/rel;
                                        }
                                        img.neww = neww;
                                        img.newh = newh;
                                        canvasResult.id = "result";
                                        if (img.neww < 500) {
                                            canvasResult.width = img.neww;
                                        }
                                        else {
                                            canvasResult.width = 500;
                                        }
                                        if (img.newh < 500) {
                                            canvasResult.height = img.newh;
                                        }
                                        else {
                                            canvasResult.height = 500;
                                        }
                                        canvasResult.style.zIndex   = -1;
                                        canvasResult.style.display = "none";
                                        if (!document.getElementById('result')) {
                                            document.body.appendChild(canvasResult);
                                        }

                                        canvas.setAttribute('width', 500);
                                        canvas.setAttribute('height', 500);
                                        overlay.setAttribute('width', 500);
                                        overlay.setAttribute('height', 500);
                                        webgl.setAttribute('width', 500);
                                        webgl.setAttribute('height', 500);
                                        cc.drawImage(img,0,0,neww, newh);
                                    } else {
                                        canvas.setAttribute('width', 500);
                                        canvas.setAttribute('height', 500);
                                        overlay.setAttribute('width', 500);
                                        overlay.setAttribute('height', 500);
                                        webgl.setAttribute('width', 500);
                                        webgl.setAttribute('height', 500);
                                        cc.drawImage(img,0,0,img.width, img.height);
                                    }
                                }

                                img.src = e.target.result;
                                // originalImageWidth = img.width;
                                // originalImageHeight = img.height;
                                // $( "#result" ).remove();
                                // var canvasResult = document.createElement('canvas');
                                gl = getWebGLContext(webgl); 
                                gl.clear(gl.DEPTH_BUFFER_BIT | gl.COLOR_BUFFER_BIT);
                                $("#ninguno").click();
                                // console.log(gl);

                            };
                        })(fileList[fileIndex]);
                        reader.readAsDataURL(fileList[fileIndex]);
                        overlayCC.clearRect(0, 0, 720, 576); 
                        // console.log(overlayCC);              
                        document.getElementById('convergence').innerHTML = "";
                        ctrack.reset();
                        
                        // $('#overlay').hide();
                    }

                }

                // set up file selector and variables to hold selections
                var fileList, fileIndex;
                if (window.File && window.FileReader && window.FileList) {
                    function handleFileSelect(evt) {
                        var files = evt.target.files;
                        fileList = [];
                        for (var i = 0;i < files.length;i++) {
                            if (!files[i].type.match('image.*')) {
                                continue;
                            }
                            fileList.push(files[i]);
                        }
                        if (files.length > 0) {
                            fileIndex = 0;
                        }
                        
                        loadImage();
                    }
                    document.getElementById('file-input').addEventListener('change', handleFileSelect, false);
                } else {
                    $('#file-input').addClass("hide");
                    $('#loadimagetext').addClass("hide");
                }
    </script>
            <script>
                // when everything is ready, automatically start everything ?

                var vid = document.getElementById('image');
                var overlay = document.getElementById('overlay');
                var overlayCC = overlay.getContext('2d');   
                
                /*********** Setup of video/webcam and checking for webGL support *********/

                var videoReady = false;
                var imagesReady = false;
                
                function enablestart() {
                    if (videoReady && imagesReady) {
                        var startbutton = document.getElementById('startbutton');
                        startbutton.value = "start";
                        startbutton.disabled = null;
                    }
                }

                $(window).load(function() {
                    imagesReady = true;
                    enablestart();
                });
                
                var insertAltVideo = function(video) {
                    if (supports_video()) {
                        if (supports_ogg_theora_video()) {
                            video.src = "../media/cap13_edit2.ogv";
                        } else if (supports_h264_baseline_video()) {
                            video.src = "../media/cap13_edit2.mp4";
                        } else {
                            return false;
                        }
                        //video.play();
                        return true;
                    } else return false;
                }

                // check whether browser supports webGL
                var webGLContext;
                var webGLTestCanvas = document.createElement('canvas');
                if (window.WebGLRenderingContext) {
                    webGLContext = webGLTestCanvas.getContext('webgl') || webGLTestCanvas.getContext('experimental-webgl');
                    if (!webGLContext || !webGLContext.getExtension('OES_texture_float')) {
                        webGLContext = null;
                    }
                }
                if (webGLContext == null) {
                    alert("Tu navegador no soporta WebGL. Por favor intenta en otro navegador.");
                }
                
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;
                
                // check for camerasupport
                // if (navigator.getUserMedia) {
                //     // set up stream
                    
                //     // chrome 19 shim
                //     var videoSelector = {video : true};
                //     if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
                //         var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
                //         if (chromeVersion < 20) {
                //             videoSelector = "video";
                //         }
                //     };
                    
                //     navigator.getUserMedia(videoSelector, function( stream ) {
                //         if (vid.mozCaptureStream) {
                //             vid.mozSrcObject = stream;
                //         } else {
                //             vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
                //         }
                //         // vid.play();
                //     }, function() {
                //         insertAltVideo(vid);
                //         alert("There was some problem trying to fetch video from your webcam, using a fallback video instead.");
                //     });
                // } else {
                //     insertAltVideo(vid);
                //     alert("Your browser does not seem to support getUserMedia, using a fallback video instead.");
                // }

                vid.addEventListener('canplay', function() {videoReady = true;enablestart();}, false);

                /*********** Code for face substitution *********/
                
                var animationRequest;
                var positions;

                var ctrack = new clm.tracker();
                ctrack.init(pModel);

                function startVideo() {
                    // start video
                    // vid.play();
                    // start tracking
                    ctrack.start(vid);
                    // start drawing face grid
                    drawGridLoop();
                }

                var fd = new faceDeformer();
                var webGLCanvasEl = document.getElementById('webgl');
                var originalCanvasContext = document.getElementById('image').getContext('2d'); 
                var wc1 = webGLCanvasEl.getContext('webgl', {preserveDrawingBuffer: true}) || document.getElementById('webgl').getContext('experimental-webgl', {preserveDrawingBuffer: true});
                fd.init(document.getElementById('webgl'));
                // console.log(fd);
                wc1.clearColor(0,0,0,0);
                
                // canvas for copying the warped face to
                var newcanvas = document.createElement('CANVAS');
                newcanvas.width = vid.width;
                newcanvas.height = vid.height;
                // canvas for copying videoframes to
                var videocanvas = document.createElement('CANVAS');
                videocanvas.width = vid.width;
                videocanvas.height = vid.height;

                var mouth_vertices = [
                  [44,45,61,44],
                  [45,46,61,45],
                  [46,60,61,46],
                  [46,47,60,46],
                  [47,48,60,47],
                  [48,59,60,48],
                  [48,49,59,48],
                  [49,50,59,49],
                  [50,51,58,50],
                  [51,52,58,51],
                  [52,57,58,52],
                  [52,53,57,52],
                  [53,54,57,53],
                  [54,56,57,54],
                  [54,55,56,54],
                  [55,44,56,55],
                  [44,61,56,44],
                  [61,60,56,61],
                  [56,57,60,56],
                  [57,59,60,57],
                  [57,58,59,57],
                  [50,58,59,50],
                ];

                var extendVertices = [
                  [0,71,72,0],
                  [0,72,1,0],
                  [1,72,73,1],
                  [1,73,2,1],
                  [2,73,74,2],
                  [2,74,3,2],
                  [3,74,75,3],
                  [3,75,4,3],
                  [4,75,76,4],
                  [4,76,5,4],
                  [5,76,77,5],
                  [5,77,6,5],
                  [6,77,78,6],
                  [6,78,7,6],
                  [7,78,79,7],
                  [7,79,8,7],
                  [8,79,80,8],
                  [8,80,9,8],
                  [9,80,81,9],
                  [9,81,10,9],
                  [10,81,82,10],
                  [10,82,11,10],
                  [11,82,83,11],
                  [11,83,12,11],
                  [12,83,84,12],
                  [12,84,13,12],
                  [13,84,85,13],
                  [13,85,14,13],
                  [14,85,86,14],
                  [14,86,15,14],
                  [15,86,87,15],
                  [15,87,16,15],
                  [16,87,88,16],
                  [16,88,17,16],
                  [17,88,89,17],
                  [17,89,18,17],
                  [18,89,93,18],
                  [18,93,22,18],
                  [22,93,21,22],
                  [93,92,21,93],
                  [21,92,20,21],
                  [92,91,20,92],
                  [20,91,19,20],
                  [91,90,19,91],
                  [19,90,71,19],
                  [19,71,0,19]
                ]

                function drawGridLoop() {
                    // get position of face
                    positions = ctrack.getCurrentPosition(vid);

                    overlayCC.clearRect(0, 0, 500, 375);
                    if (positions) {
                        // draw current grid
                        //ctrack.draw(overlay);
                    }
                    // check whether mask has converged
                    var pn = ctrack.getConvergence();
                    if (pn < 0.4) {
                        //switchMasks(positions);
                        drawMaskLoop();
                    } else {
                        requestAnimFrame(drawGridLoop);
                    }
                }
                    
                function drawMaskLoop() {
                    videocanvas.getContext('2d').drawImage(vid,0,0,videocanvas.width,videocanvas.height);
                    
                    var pos = ctrack.getCurrentPosition(vid);
                    // create additional points around face
                    var tempPos;
                    var addPos = [];
                    for (var i = 0;i < 23;i++) {
                        tempPos = [];
                        tempPos[0] = (pos[i][0] - pos[62][0])*1.3 + pos[62][0];
                        tempPos[1] = (pos[i][1] - pos[62][1])*1.3 + pos[62][1];
                        addPos.push(tempPos);
                    }
                    // merge with pos
                    var newPos = pos.concat(addPos);

                    var newVertices = pModel.path.vertices.concat(mouth_vertices);
                    // merge with newVertices
                    newVertices = newVertices.concat(extendVertices);
                    
                    fd.load(videocanvas, newPos, pModel, newVertices);

                    // get position of face
                    //positions = ctrack.getCurrentPosition();
                    
                    var parameters = ctrack.getCurrentParameters();
                    for (var i = 6;i < parameters.length;i++) {
                        parameters[i] += ph['component '+(i-3)];
                        /*if (i == 23) {
                            parameters[i] += 20;
                        }*/
                    }
                    positions = ctrack.calculatePositions(parameters);

                    /*for (var i = 0;i < positions.length;i++) {
                        positions[i][1] += 1;
                    }*/

                    overlayCC.clearRect(0, 0, 400, 300);
                    if (positions) {
                        // add positions from extended boundary, unmodified
                        newPos = positions.concat(addPos);
                        // draw mask on top of face
                        fd.draw(newPos);
                    }
                    animationRequest = requestAnimFrame(drawMaskLoop);
                }
                
                /*********** Code for stats **********/

                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                document.getElementById('container').appendChild( stats.domElement );

                document.addEventListener("clmtrackrIteration", function(event) {
                    stats.update();
                }, false);

                /********** parameter code *********/

                var pnums = pModel.shapeModel.eigenValues.length-2;
                var parameterHolder = function() {
                    for (var i = 0;i < pnums;i++) {
                        this['component '+(i+3)] = 0;
                    }
                    this.presets = 0;
                };

                var ph = new parameterHolder();
                var gui = new dat.GUI();
            
                var presets = {
                    "Malestar" : [0, 0, 0, 0, 0, 0, 22, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    "Inca" : [0, 0, -9, 0, -11, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0],
                    "Alegre" : [0, 0, -9, 9, -11, 0, 0, 0, 0, 0, 0, 0, -9, 0, 0, 0, 0, 0],
                    "Atontado" : [0, 0, 0, 0, 0, 0, 0, -11, 0, 0, 0, 0, 0, 0, 20, 0, 0, 0],
                    "Cara larga" : [0, 0, 0, 0, -15, 0, 0, -12, 0, 0, 0, 0, 0, 0, -7, 0, 0, 5],
                    "Suertudo" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -4, 0, -6, 12, 0, 0],
                    "Lindo" : [0, 0, 0, 0, 16, 0, -14, 0, 0, 0, 0, 0, -7, 0, 0, 0, 0, 0],
                    "Dormido" : [0, 0, 0, 0, 0, 0, 0, -8, 0, 0, 0, 0, 0, 0, -2, 0, 0, 10],
                    "Malvado" : [0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, -8],
                    "Artificial" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, -16, 0, 0, 0, 0, 0],
                    "Ninguno" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                };
                
                var control = {};
                var eig = 0;
                for (var i = 0;i < pnums;i++) {
                    eig = Math.sqrt(pModel.shapeModel.eigenValues[i+2])*3
                    control['c'+(i+3)] = gui.add(ph, 'component '+(i+3), -5*eig, 5*eig).listen();
                }
                
                /********** defaults code **********/

                function switchDeformedFace(e) {
                    startVideo();
                    //var split = ph.presets.split(",");
                    for (var i = 0;i < pnums;i++) {
                        console.log(e.target.value);
                        ph['component '+(i+3)] = presets[e.target.value][i];
                    }
                }

                // document.getElementById('deform').addEventListener('change', switchDeformedFace, false);
                document.getElementById('malestar').addEventListener('click', switchDeformedFace, false);
                document.getElementById('inca').addEventListener('click', switchDeformedFace, false);
                document.getElementById('alegre').addEventListener('click', switchDeformedFace, false);
                document.getElementById('atontado').addEventListener('click', switchDeformedFace, false);
                document.getElementById('larga').addEventListener('click', switchDeformedFace, false);
                document.getElementById('suertudo').addEventListener('click', switchDeformedFace, false);
                document.getElementById('lindo').addEventListener('click', switchDeformedFace, false);
                document.getElementById('dormido').addEventListener('click', switchDeformedFace, false);
                document.getElementById('malvado').addEventListener('click', switchDeformedFace, false);
                document.getElementById('aritificial').addEventListener('click', switchDeformedFace, false);
                document.getElementById('ninguno').addEventListener('click', switchDeformedFace, false);

                for (var i = 0;i < pnums;i++) {
                    ph['component '+(i+3)] = presets['unwell'][i];
                }
            </script>
    <canvas width="11px" height="781px" id="renderCanvas" style="display:none;"></canvas>
</body>
</html>